// Complete Blackjack rules engine with all variations

export const DEFAULT_COMPREHENSIVE_RULES = {
  // Deck & Penetration
  numDecks: 6,
  penetration: 75,
  
  // Dealer Behavior
  dealerHitsSoft17: false, // S17 = false, H17 = true
  
  // Hole Card Rules
  holeCardRule: 'american', // 'american', 'enhc', 'ealob'
  
  // Blackjack Payout
  blackjackPays: 1.5, // 3:2=1.5, 6:5=1.2, 1:1=1.0, 2:1=2.0
  
  // Doubling Rules
  doubleAllowed: 'any', // 'any', '9-11', '10-11', '8-11'
  das: true, // Double After Split
  doubleSoft: true,
  
  // Splitting Rules
  maxSplits: 3, // Max number of times you can split (1-4)
  resplitAces: false,
  hitSplitAces: false,
  splitTens: true,
  bjAfterSplitCountsAsBJ: false,
  
  // Surrender Rules
  surrender: 'late', // 'none', 'late', 'early-10', 'early-ace', 'early-both'
  
  // Additional Mechanics
  insurance: true,
  nmse: false, // No Mid-Shoe Entry
  csm: false, // Continuous Shuffle Machine
  push22: false, // Push 22 rule (dealer 22 pushes vs all non-busted hands)
  
  // Counting System
  countingSystem: 'Hi-Lo'
};

// EV Impact modifiers (in percentage points)
export const EV_MODIFIERS = {
  // Dealer rules
  h17: 0.20,
  
  // Blackjack payouts (relative to 3:2)
  blackjack_6to5: 1.39,
  blackjack_1to1: 2.30,
  blackjack_2to1: -0.70,
  
  // Hole card rules
  enhc: 0.11,
  ealob: 0.20, // Average between 0.18-0.22
  
  // Double restrictions
  no_soft_double: 0.14,
  double_10_11_only: 0.28,
  double_9_11_only: 0.15,
  double_8_11_only: 0.10,
  
  // Split restrictions
  no_das: 0.14,
  no_resplit_aces: 0.07,
  no_hit_split_aces: 0.19,
  bj_after_split_counts: -0.12,
  
  // Surrender benefits (negative = good for player)
  late_surrender: -0.07,
  early_surrender_10: -0.24,
  early_surrender_ace: -0.39,
  early_surrender_both: -0.63,
  
  // Other rules
  nmse: 0.04,
  push22: 1.40,
  
  // Deck composition (per deck reduction from 6 decks)
  fewer_decks_per_deck: -0.06
};

export function calculateBaseHouseEdge(rules) {
  let houseEdge = 0.48; // Base house edge for 6-deck S17 DAS 3:2
  
  // Deck adjustment
  const deckDiff = 6 - rules.numDecks;
  houseEdge -= deckDiff * EV_MODIFIERS.fewer_decks_per_deck;
  
  // Dealer behavior
  if (rules.dealerHitsSoft17) {
    houseEdge += EV_MODIFIERS.h17;
  }
  
  // Blackjack payout
  if (rules.blackjackPays === 1.2) {
    houseEdge += EV_MODIFIERS.blackjack_6to5;
  } else if (rules.blackjackPays === 1.0) {
    houseEdge += EV_MODIFIERS.blackjack_1to1;
  } else if (rules.blackjackPays === 2.0) {
    houseEdge += EV_MODIFIERS.blackjack_2to1;
  }
  
  // Hole card rules
  if (rules.holeCardRule === 'enhc') {
    houseEdge += EV_MODIFIERS.enhc;
  } else if (rules.holeCardRule === 'ealob') {
    houseEdge += EV_MODIFIERS.ealob;
  }
  
  // Doubling restrictions
  if (!rules.doubleSoft) {
    houseEdge += EV_MODIFIERS.no_soft_double;
  }
  
  if (rules.doubleAllowed === '10-11') {
    houseEdge += EV_MODIFIERS.double_10_11_only;
  } else if (rules.doubleAllowed === '9-11') {
    houseEdge += EV_MODIFIERS.double_9_11_only;
  } else if (rules.doubleAllowed === '8-11') {
    houseEdge += EV_MODIFIERS.double_8_11_only;
  }
  
  // Split rules
  if (!rules.das) {
    houseEdge += EV_MODIFIERS.no_das;
  }
  
  if (!rules.resplitAces) {
    houseEdge += EV_MODIFIERS.no_resplit_aces;
  }
  
  if (!rules.hitSplitAces) {
    houseEdge += EV_MODIFIERS.no_hit_split_aces;
  }
  
  if (rules.bjAfterSplitCountsAsBJ) {
    houseEdge += EV_MODIFIERS.bj_after_split_counts;
  }
  
  // Surrender
  if (rules.surrender === 'late') {
    houseEdge += EV_MODIFIERS.late_surrender;
  } else if (rules.surrender === 'early-10') {
    houseEdge += EV_MODIFIERS.early_surrender_10;
  } else if (rules.surrender === 'early-ace') {
    houseEdge += EV_MODIFIERS.early_surrender_ace;
  } else if (rules.surrender === 'early-both') {
    houseEdge += EV_MODIFIERS.early_surrender_both;
  }
  
  // Other mechanics
  if (rules.nmse) {
    houseEdge += EV_MODIFIERS.nmse;
  }
  
  if (rules.push22) {
    houseEdge += EV_MODIFIERS.push22;
  }
  
  return houseEdge;
}

export function calculateCountAdjustedEV(baseHouseEdge, trueCount, rules) {
  // CSM disables counting
  if (rules.csm) {
    return -baseHouseEdge;
  }
  
  // Standard: +0.5% per TC point
  const countAdvantage = trueCount * 0.5;
  
  return countAdvantage - baseHouseEdge;
}

export function recommendBetUnits(trueCount, rules) {
  // CSM = flat betting
  if (rules.csm) return 1;
  
  // Conservative Kelly-based spread
  if (trueCount <= 0) return 0; // Wonging out recommended
  if (trueCount === 1) return 1;
  if (trueCount === 2) return 2;
  if (trueCount === 3) return 4;
  if (trueCount === 4) return 6;
  if (trueCount >= 5) return 8;
  
  return 1;
}
